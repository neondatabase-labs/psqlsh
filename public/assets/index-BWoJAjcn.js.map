{"version":3,"file":"index-BWoJAjcn.js","sources":["../../../node_modules/@segment/analytics-next/dist/pkg/plugins/remote-middleware/index.js"],"sourcesContent":["import { __awaiter, __generator } from \"tslib\";\nimport { isServer } from '../../core/environment';\nimport { loadScript } from '../../lib/load-script';\nimport { getNextIntegrationsURL } from '../../lib/parse-cdn';\nexport function remoteMiddlewares(ctx, settings, obfuscate) {\n    var _a;\n    return __awaiter(this, void 0, void 0, function () {\n        var path, remoteMiddleware, names, scripts, middleware;\n        var _this = this;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0:\n                    if (isServer()) {\n                        return [2 /*return*/, []];\n                    }\n                    path = getNextIntegrationsURL();\n                    remoteMiddleware = (_a = settings.enabledMiddleware) !== null && _a !== void 0 ? _a : {};\n                    names = Object.entries(remoteMiddleware)\n                        .filter(function (_a) {\n                        var _ = _a[0], enabled = _a[1];\n                        return enabled;\n                    })\n                        .map(function (_a) {\n                        var name = _a[0];\n                        return name;\n                    });\n                    scripts = names.map(function (name) { return __awaiter(_this, void 0, void 0, function () {\n                        var nonNamespaced, bundleName, fullPath, error_1;\n                        return __generator(this, function (_a) {\n                            switch (_a.label) {\n                                case 0:\n                                    nonNamespaced = name.replace('@segment/', '');\n                                    bundleName = nonNamespaced;\n                                    if (obfuscate) {\n                                        bundleName = btoa(nonNamespaced).replace(/=/g, '');\n                                    }\n                                    fullPath = \"\".concat(path, \"/middleware/\").concat(bundleName, \"/latest/\").concat(bundleName, \".js.gz\");\n                                    _a.label = 1;\n                                case 1:\n                                    _a.trys.push([1, 3, , 4]);\n                                    return [4 /*yield*/, loadScript(fullPath)\n                                        // @ts-ignore\n                                    ];\n                                case 2:\n                                    _a.sent();\n                                    // @ts-ignore\n                                    return [2 /*return*/, window[\"\".concat(nonNamespaced, \"Middleware\")]];\n                                case 3:\n                                    error_1 = _a.sent();\n                                    ctx.log('error', error_1);\n                                    ctx.stats.increment('failed_remote_middleware');\n                                    return [3 /*break*/, 4];\n                                case 4: return [2 /*return*/];\n                            }\n                        });\n                    }); });\n                    return [4 /*yield*/, Promise.all(scripts)];\n                case 1:\n                    middleware = _b.sent();\n                    middleware = middleware.filter(Boolean);\n                    return [2 /*return*/, middleware];\n            }\n        });\n    });\n}\n//# sourceMappingURL=index.js.map"],"names":["remoteMiddlewares","ctx","settings","obfuscate","_a","__awaiter","path","remoteMiddleware","names","scripts","middleware","_this","__generator","_b","isServer","getNextIntegrationsURL","enabled","name","nonNamespaced","bundleName","fullPath","error_1","loadScript"],"mappings":"6XAIO,SAASA,EAAkBC,EAAKC,EAAUC,EAAW,CACxD,IAAIC,EACJ,OAAOC,EAAU,KAAM,OAAQ,OAAQ,UAAY,CAC/C,IAAIC,EAAMC,EAAkBC,EAAOC,EAASC,EACxCC,EAAQ,KACZ,OAAOC,EAAY,KAAM,SAAUC,EAAI,CACnC,OAAQA,EAAG,MAAK,CACZ,IAAK,GACD,OAAIC,EAAQ,EACD,CAAC,EAAc,CAAA,CAAE,GAE5BR,EAAOS,EAAsB,EAC7BR,GAAoBH,EAAKF,EAAS,qBAAuB,MAAQE,IAAO,OAASA,EAAK,GACtFI,EAAQ,OAAO,QAAQD,CAAgB,EAClC,OAAO,SAAUH,EAAI,CACdA,EAAG,CAAC,EAAG,IAAAY,EAAUZ,EAAG,CAAC,EAC7B,OAAOY,CAC/B,CAAqB,EACI,IAAI,SAAUZ,EAAI,CACnB,IAAIa,EAAOb,EAAG,CAAC,EACf,OAAOa,CAC/B,CAAqB,EACDR,EAAUD,EAAM,IAAI,SAAUS,EAAM,CAAE,OAAOZ,EAAUM,EAAO,OAAQ,OAAQ,UAAY,CACtF,IAAIO,EAAeC,EAAYC,EAAUC,EACzC,OAAOT,EAAY,KAAM,SAAUR,EAAI,CACnC,OAAQA,EAAG,MAAK,CACZ,IAAK,GACDc,EAAgBD,EAAK,QAAQ,YAAa,EAAE,EAC5CE,EAAaD,EACTf,IACAgB,EAAa,KAAKD,CAAa,EAAE,QAAQ,KAAM,EAAE,GAErDE,EAAW,GAAG,OAAOd,EAAM,cAAc,EAAE,OAAOa,EAAY,UAAU,EAAE,OAAOA,EAAY,QAAQ,EACrGf,EAAG,MAAQ,EACf,IAAK,GACD,OAAAA,EAAG,KAAK,KAAK,CAAC,EAAG,EAAC,CAAI,CAAC,CAAC,EACjB,CAAC,EAAakB,EAAWF,CAAQ,CAE5E,EACgC,IAAK,GACD,OAAAhB,EAAG,KAAI,EAEA,CAAC,EAAc,OAAO,GAAG,OAAOc,EAAe,YAAY,CAAC,CAAC,EACxE,IAAK,GACD,OAAAG,EAAUjB,EAAG,OACbH,EAAI,IAAI,QAASoB,CAAO,EACxBpB,EAAI,MAAM,UAAU,0BAA0B,EACvC,CAAC,EAAa,CAAC,EAC1B,IAAK,GAAG,MAAO,CAAC,EACnB,CAC7B,CAAyB,CACzB,CAAqB,CAAI,CAAA,EACE,CAAC,EAAa,QAAQ,IAAIQ,CAAO,CAAC,GAC7C,IAAK,GACD,OAAAC,EAAaG,EAAG,OAChBH,EAAaA,EAAW,OAAO,OAAO,EAC/B,CAAC,EAAcA,CAAU,CACvC,CACb,CAAS,CACT,CAAK,CACL","x_google_ignoreList":[0]}